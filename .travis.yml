env:
  global:
    - TAG_NAME=v0.0.1
if: tag IS blank
sudo: required
jobs:
  include:
    - name: "Python 3.7 on Linux"
      env: RELEASE_FILENAME=bilidrive-$TAG_NAME-linux-amd64.tar.gz
      language: python
      python: 3.7
      before_deploy:
        - tar czvf $RELEASE_FILENAME ./release/BiliDrive

    - name: "Python 3.7 on Linux (ARM)"
      arch: arm64
      env: RELEASE_FILENAME=bilidrive-$TAG_NAME-linux-arm64.tar.gz
      language: python
      python: 3.7
      before_deploy:
        - tar czvf $RELEASE_FILENAME ./release/BiliDrive

    - name: "Python 3.7 on macOS"
      env: RELEASE_FILENAME=bilidrive-$TAG_NAME-macos-amd64.tar.gz
      language: shell
      os: osx
      osx_image: xcode11.2
      before_deploy:
        - tar czvf $RELEASE_FILENAME ./release/BiliDrive

    - name: "Python 3.7 on Windows"
      env:
        - PATH=/c/Python37:/c/Python37/Scripts:$PATH
        - RELEASE_FILENAME=bilidrive-$TAG_NAME-windows-amd64.zip
      language: shell
      os: windows
      before_deploy:
        - 7z a -tzip $RELEASE_FILENAME ./release/BiliDrive
      before_install:
        - choco install python --version 3.7
        - choco install 7zip
        - python -m pip install --upgrade pip
install:
  - pip3 install --upgrade pip
  - pip3 install -r requirements.txt
  - pip3 install pyinstaller
script:
  - pyinstaller -F -n BiliDrive drive.py
after_success:
  - mkdir -r ./release/BiliDrive
  - cp ./dist/* ./release/BiliDrive/
  - cp ./README.md ./release/BiliDrive/
deploy:
  provider: releases
  api_key: $GITHUB_OAUTH_TOKEN
  file: $RELEASE_FILENAME
  skip_cleanup: true
  overwrite: true
  tag_name: $TAG_NAME
